# 데이터베이스 정리 기능 문서

## 개요
QuickPoll 애플리케이션에 데이터베이스 정리 기능이 추가되었습니다. 이 기능은 만료된 지 7일이 지난 투표와 관련 데이터를 자동으로 삭제하여 데이터베이스를 깔끔하게 유지합니다.

## 정리 정책
- **보관 기간**: 투표 만료일로부터 7일
- **삭제 대상**:
  - 만료된 지 7일이 지난 투표 (polls 테이블)
  - 해당 투표의 모든 투표 기록 (votes 테이블)

## 구현 내용

### 1. 데이터베이스 함수
- **함수명**: `cleanup_expired_polls()`
- **반환값**: 삭제된 투표 개수 (INTEGER)
- **동작**:
  1. 만료된 지 7일이 지난 투표의 모든 votes 삭제
  2. 해당 polls 레코드 삭제
  3. 삭제된 투표 개수 반환

### 2. 자동 정리 (Cron Job)
- **실행 시간**: 매일 UTC 오전 2시 (한국 시간 오전 11시)
- **작업명**: `cleanup-expired-polls`
- **pg_cron** 확장을 사용하여 자동 실행

### 3. 수동 정리 (Admin Page)
- **접속 경로**: `/admin`
- **기능**:
  - 현재 통계 확인 (만료된 투표, 삭제 대상 투표, 삭제 예정 투표 수)
  - 삭제 예정 투표 목록 확인
  - 수동 정리 실행 버튼
  - 실행 결과 표시

### 4. 서비스 함수 (admin.ts)
```typescript
// 만료된 투표 정리
cleanupExpiredPolls(): Promise<{ success: boolean; deletedCount?: number; error?: string }>

// 정리 통계 조회
getCleanupStats(): Promise<{ expiredPolls: number; pollsToDelete: number; votesToDelete: number } | null>

// 삭제 예정 투표 목록 조회
getExpiredPolls(): Promise<any[]>
```

## 사용 방법

### 관리자 페이지 접속
1. 브라우저에서 `/admin` 경로로 이동
2. 통계 확인:
   - 만료된 투표: 현재 만료된 모든 투표 수
   - 삭제 대상 투표: 7일이 지나 삭제 예정인 투표 수
   - 삭제 대상 투표 수: 삭제될 votes 레코드 수

3. 수동 정리 실행:
   - "지금 정리하기" 버튼 클릭
   - 확인 메시지에서 "확인" 선택
   - 정리 결과 확인

### 자동 정리
- 별도 작업 불필요
- 매일 자동으로 실행됨
- 서버 로그에서 실행 결과 확인 가능

## 보안 고려사항
- 관리자 페이지는 현재 인증 없이 접근 가능
- 프로덕션 환경에서는 인증 추가 권장
- 삭제 작업 전 확인 메시지 표시
- 삭제된 데이터는 복구 불가능

## 성능 영향
- 정리 작업은 데이터베이스 부하를 최소화하기 위해 새벽 시간에 실행
- CASCADE 삭제로 관련 데이터 자동 정리
- 인덱스를 활용한 효율적인 쿼리 실행

## 모니터링
- 관리자 페이지에서 정리 전후 통계 확인
- 실행 결과 메시지로 성공/실패 확인
- 삭제된 투표 개수 표시

## 향후 개선 사항
- [ ] 관리자 인증 기능 추가
- [ ] 정리 정책 커스터마이징 (보관 기간 설정)
- [ ] 정리 이력 로깅 및 조회 기능
- [ ] 특정 투표 제외 기능 (중요 투표 보관)
- [ ] 백업 후 삭제 옵션